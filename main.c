#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "Exo2/matrice2d.h"

char* read_file(char *file) {
    char *lu = (char *) malloc(sizeof(char));
    lu[0] = '\0';
    char tmp[50];
    char* tmp2;


    FILE *ptr_file = NULL;
    ptr_file = fopen(file, "r");
    if (ptr_file == NULL) {
        printf("erreur lecture !");
        exit(1);
    } else {
        while( fgets ( tmp, 50, ptr_file ) != NULL ) {
            strcat(lu, tmp);
        }
        printf("\nClosing the file test.c\n") ;
    }
    fclose(ptr_file);
    return lu;
}

t_matrice readFileAndCreate2dArray(char *fileName) {
    FILE *fichier = NULL;
    fichier = fopen(fileName, "r");
    if (fichier == NULL) {
        printf("Erreur d'ouverture du fichier\n");
        exit(EXIT_FAILURE);
    }
    int nbLignes = 0;
    int nbColonnes = 0;
    fscanf(fichier, "%d %d", &nbLignes, &nbColonnes);
    t_matrice matrice = *allouer_matrice(nbLignes, nbColonnes);
    int i = 0;
    int j = 0;
    int valeur = 0;
    while (fscanf(fichier, "%d", &valeur) != EOF) {
        matrice.coefficient[i][j] = valeur;
        j++;
        if (j == nbColonnes) {
            j = 0;
            i++;
        }
    }
    fclose(fichier);
    return matrice;
}



void *write_char(char *file_entree, char *ecriture) {
    FILE *ptr_file = NULL;
    char tmp;

    if (ptr_file = fopen(file_entree, "w") == NULL) {
        printf("erreur écriture !");
        exit(1);
    } else if (file_entree != NULL) {
        fputs(ecriture, file_entree);
        printf("ecriture reussi ! ");
    };
}

char *copier_fichier(char *file_entree, char *file_sortie) {
    FILE *ptr_file = NULL;
    char tmp;
    char *lu = (char *) malloc(sizeof(char));
    lu[0] = '\0';

    if (ptr_file = fopen(file_entree, "w") == NULL) {
        printf("erreur lecture !");
        exit(1);
    } else {
// lit les 100 premiers caractères du fichier et les placent dans tmp
        while (fgets(tmp, 100, ptr_file)) {
            lu = (char *) malloc(strlen(tmp) * sizeof(char));
            strcpy(lu, tmp);
            fputs(tmp, file_entree);
        }
        printf("ecriture reussi ! ");
    }

    return file_sortie;
}

t_matrice *atomatrice(char *chaine_caractere) {
    int ligne = 0;
    int colonne = 0;
    char chaine_finale[100];
    char *compteur = chaine_caractere;
    t_matrice *matrice_finale = NULL;


//on va lire chacun des caractères de la ligne allant décrire le nombre de lignes et de colonnes de la matrice étudiée
// on utilise sscanf pour copier le caractère initial du fichier dans la variable finale "chaine finale"
    sscanf(compteur, "%s", chaine_finale);

// permet de convertir le caractère ASCII de caractère en integer (on a pas utilisé atof car il permet de convertir l'ASCII en float, ce qui n'est pas nécessaire dans notre cas)
    ligne = atoi(chaine_finale);

// on va passer à la lecture du caractère suivant (on lit les 100 premiers caractères au total) :
    for (int k = 1; k < 101; k++) {
        compteur += chaine_finale[k];

    }

//on réalise la même procédure pour le caractère suivant correspondant au nbre de colonnes
    sscanf(compteur, "%s", chaine_finale);
    colonne = atoi(chaine_finale);

    for (int k = 1; k < 101; k++) {
        compteur += chaine_finale[k];

    }

// on initialise une matrice en fct de la lecture précédente :
    matrice_finale = allouer_matrice(ligne, colonne);
    int ecriture_finale;

// on écrit les différents coefficients lus de la matrice dans chaine_finale selon les 100 premières lignes et colonnes, on augmente aussi au fur et à mesure le compteur de caractère
    for (int i = 1; i < 101; i++) {
        for (int j = 1; j < 101; j++) {
            sscanf(compteur, "%s", chaine_finale);

// on les convertit en integer afin de pouvoir effectuer le calcul sur ces derniers
            ecriture_finale = atoi(chaine_finale);
            matrice_finale->coefficient[i][j] = ecriture_finale;
//on place le compteur au niveau du dernier caractère lu : on a donc terminé la lecture de la chaine de caracteres
            compteur += strlen(chaine_finale);


        }
    }

    return matrice_finale;
}


int main() {
    char* ss = read_file("/Users/macbook_z/Desktop/Data/EFREI/Semester 2/Systems d'exploitation/TP1/input.txt");
    printf("%s", ss);
    write_char("/Users/macbook_z/Desktop/Data/EFREI/Semester 2/Systems d'exploitation/TP1/output.txt", ss);

    t_matrice matrice = readFileAndCreate2dArray("/Users/macbook_z/Desktop/Data/EFREI/Semester 2/Systems d'exploitation/TP1/input.txt");
    //display_tableau(matrice);
    return 0;
}